@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <title>Stumptown40</title>
    <style>
        body
        {
            background: #666;
        }

        a
        {
            color: #fff;
        }

        h1
        {
            color: #CCC;
            font: normal normal normal 200% Arial;
        }

        .hidden
        {
            display: none;
        }

        #bracketView input
        {
            height: 60px;
            width: 80px;
            font-size: 140%;
        }

        #bracketView ul li
        {
            list-style: none;
            margin: 0 0 20px 0;
        }

        #roundView input.selected
        {
            background: yellow;
        }

        #roundView table tr td
        {
            padding: 20px;
        }

        #roundView table tr td.c1 input,
        #roundView table tr td.c4 input
        {
            width: 60px;
            height: 60px;
            font-size: 150%;
        }

        #roundView table tr td.c2 input,
        #roundView table tr td.c3 input
        {
            width: 300px;
            height: 60px;
            font-size: 120%;
            text-align: left;
        }

        #menu
        {
            margin: 0 0 20px 0;
            padding: 0;
        }

            #menu li
            {
                display: inline;
                font: normal normal bold 14pt Verdana;
                margin-right: 20px;
            }

        #adminView li
        {
            list-style: none;
            margin: 0 0 20px 0;
        }

        #adminView input
        {
            height: 60px;
            width: 320px;
            font-size: 140%;
        }
        .subHeader { background: #000;padding: 30px;}
    </style>
    <script src="/Scripts/jquery-1.8.2.min.js"></script>
    <script src="/Scripts/knockout-2.2.0.js"></script>
    <script src="/Scripts/sammy-0.7.4.min.js"></script>
    <script type="text/javascript">

        function showView(viewId) {
            $('div.view').addClass('hidden');
            $(viewId).removeClass('hidden');
        }

        function RaceItem(raceId, heatNumber, racer1Id, racer1Name, racer2Id, racer2Name, winningRacerId) {
            var self = this;

            self.raceId = ko.observable(raceId);
            self.heatNumber = ko.observable(heatNumber);
            self.racer1Id = ko.observable(racer1Id);
            self.racer1Name = ko.observable(racer1Name);
            self.racer2Id = ko.observable(racer2Id);
            self.racer2Name = ko.observable(racer2Name);
            self.winningRacerId = ko.observable(winningRacerId);

            //self.raceId = raceId;
            //self.heatNumber = heatNumber;
            //self.racer1Id = racer1Id;
            //self.racer1Name = racer1Name;
            //self.racer2Id = racer2Id;
            //self.racer2Name = racer2Name;
            //self.winningRacerId = winningRacerId;
            //self.button1Id = 'button' + racer1Id;
            //self.button2Id = 'button' + racer2Id;
        }

        function RoundViewModel() {

            var self = this;

            // data

            self.rounds = [1, 2, 3, 4, 5, 6, 7];

            self.races = ko.observableArray();
            self.roundNumber = ko.observable();

            // behaviors

            self.showRound = function (roundId) {
                location.hash = 'round/' + roundId;
            };

            self.showRace = function (raceItem) {
                alert('showRace:' + raceItem.raceId);
            };

            self.showRacer1Winner = function (raceItem) {

                $.ajax({
                    url: '/api/match?matchId=' + raceItem.raceId() + '&winningracerid=' + raceItem.racer1Id(),
                    type: 'PUT',
                    success: function () {
                        raceItem.winningRacerId(raceItem.racer1Id());
                    }
                });

            };

            self.showRacer2Winner = function (raceItem) {

                $.ajax({
                    url: '/api/match?matchId=' + raceItem.raceId() + '&winningracerid=' + raceItem.racer2Id(),
                    type: 'PUT',
                    success: function () {
                        raceItem.winningRacerId(raceItem.racer2Id());
                    }
                });

            };

            self.clearRaceWinner = function (raceItem) {

                $.ajax({
                    url: '/api/match?matchId=' + raceItem.raceId() + '&winningracerid=-1',
                    type: 'PUT',
                    success: function () {
                        raceItem.winningRacerId(-1);
                    }
                });

            };

            self.showRoundView = function (roundId) {

                self.roundNumber('Show Matches for Round ' + roundId);

                self.races.removeAll();

                $.get('/api/match?roundId=' + roundId, function (data) {
                    for (var x = 0; x < data.length; x++) {
                        var m = data[x];

                        //var item = ko.observable();
                        //item.raceId(m.MatchId);
                        //item.heatNumber(m.RaceNumber);
                        //item.racer1Id(m.Racer1Id);
                        //item.racer1Name(racerCache[parseInt(m.Racer1Id)].Name);
                        //item.racer2Id(m.Racer2Id);
                        //item.racer2Name(racerCache[parseInt(m.Racer2Id)].Name);
                        //item.winningRacerId(m.WinningRacerId);

                        //self.races.push(item);
                        var racer1Id = parseInt(m.Racer1Id);
                        var racer2Id = parseInt(m.Racer2Id);

                        var racer1Name = racer1Id > 0 ? racerCache[racer1Id].Name : "???";
                        var racer2Name = racer2Id > 0 ? racerCache[racer2Id].Name : "???";

                        self.races.push(
                            new RaceItem(
                                m.MatchId,
                                m.RaceNumber,
                                m.Racer1Id,
                                racer1Name,
                                m.Racer2Id,
                                racer2Name,
                                m.WinningRacerId));
                    }
                });

                //self.races.push(new RaceItem(55, '1', 60, 'Alice' + roundId, 61, 'Bob'));
                //self.races.push(new RaceItem(56, '2', 62, 'Charles' + roundId, 63, 'Dan'));
                //self.races.push(new RaceItem(57, '3', 64, 'Eddie' + roundId, 65, 'Frank'));

                showView('#roundView');
            };

            Sammy(function () {
                this.get('#:controller', function () {
                    switch (this.params.controller) {
                        case 'round':
                            showView('#bracketView');
                            break;
                        case 'admin':
                            showView('#adminView');
                            break;
                        default:
                            alert('unexpected: ' + this.params.controller);
                            break;
                    }
                });
                this.get('#:controller/:id', function () {
                    switch (this.params.controller) {
                        case 'round':
                            self.showRoundView(this.params.id);
                            break;
                        default:
                            alert('unexpected: ' + this.params.controller);
                            break;
                    }
                });
                this.get('', function () {
                    this.app.runRoute('get', '#round');
                });
            }).run();
        }

        var racerCache = null;

        $(function () {

            $.get('/api/racers2', function (data) {
                racerCache = data;
            });

            $('#clearWinningRacersButton').click(function () {

                if (!window.confirm('Clear Winning Racers?'))
                    return;

                $.post('/Admin/ClearWinningRacers', function (isGood) {
                    if (!isGood) {
                        alert('no good!');
                    }
                });
            });

            $('#assignSequentialStartSlotsButton').click(function () {

                if (!window.confirm('Assign Sequential Start Slots Button?'))
                    return;

                $.post('/Admin/AssignSequentialStartSlots', function (isGood) {
                    if (!isGood) {
                        alert('no good!');
                    }
                });
            });

            $('#assignRandomStartSlotsButton').click(function () {

                if (!window.confirm('Assign Random Start Slots?'))
                    return;

                $.post('/Admin/AssignRandomStartSlots', function (isGood) {
                    if (!isGood) {
                        alert('no good!');
                    }
                });
            });

            $('#assignBracketsByStartSlotButton').click(function () {

                if (!window.confirm('Assign Brackets By Start Slot ?'))
                    return;

                $.post('/Admin/assignBracketsByStartSlot', function (isGood) {
                    if (!isGood) {
                        alert('no good!');
                    }
                });
            });

            ko.applyBindings(new RoundViewModel());
        });

    </script>
</head>
<body>
    <div>

        <ul id="menu">
            <li><a href="#carGallery">Gallery</a></li>
            <li><a href="#sponsors">Sponsors</a></li>
            <li><a href="#round">Bracket</a></li>
            <li><a href="#stats">Stats</a></li>
            <li><a href="#admin">Admin</a></li>
        </ul>

        <div id="bracketView" class="view">
            <h1>Brackets</h1>
            <ul data-bind="foreach: rounds">
                <li>
                    <input type="button" data-bind="value: $data, click: $root.showRound" /></li>
            </ul>
        </div>

        <div id="roundView" class="view hidden">
            <div class="subHeader">
                <a href="#round">Go Back</a>
                <input type="button" data-bind="value: roundNumber" />
            </div>
            <table>
                <tbody data-bind="foreach: races">
                    <tr>
                        <td class="c1">
                            <input type="button" data-bind="value: heatNumber, click: $root.showRace" /></td>
                        <td class="c2">
                            <input type="button" data-bind="value: racer1Name, click: $root.showRacer1Winner, css: { selected: racer1Id() > 0 && winningRacerId() == racer1Id() }" /></td>
                        <td class="c3">
                            <input type="button" data-bind="value: racer2Name, click: $root.showRacer2Winner, css: { selected: racer2Id() > 0 && winningRacerId() == racer2Id() }" /></td>
                        <td class="c4">
                            <input type="button" value="X" data-bind="click: $root.clearRaceWinner" /></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="adminView" class="view hidden">
            <h1>Admin</h1>
            <ul>
                <li>
                    <input id="clearWinningRacersButton" type="button" value="Clear Winning Racers" /></li>
                <li>
                    <input id="assignSequentialStartSlotsButton" type="button" value="Assign Sequential Start Slots" /></li>
                <li>
                    <input id="assignRandomStartSlotsButton" type="button" value="Assign Random Start Slots" /></li>
                <li>
                    <input id="assignBracketsByStartSlotButton" type="button" value="Assign Brackets By Start Slot" /></li>
            </ul>
        </div>

    </div>
</body>
</html>
