@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <title>Stumptown40</title>
    <style>
        body { background: #666; }
        a { color: #fff;}
        .hidden { display: none; }
        #roundView input.selected {
            background: yellow;
        }
    </style>
    <script src="/Scripts/jquery-1.8.2.min.js"></script>
    <script src="/Scripts/knockout-2.2.0.js"></script>
    <script src="/Scripts/sammy-0.7.4.min.js"></script>
    <script type="text/javascript">

        function showView(viewId) {
            $('div.view').addClass('hidden');
            $(viewId).removeClass('hidden');
        }
        
        function RaceItem(raceId, heatNumber, racer1Id, racer1Name, racer2Id, racer2Name, winningRacerId) {
            var self = this;
            self.raceId = raceId;
            self.heatNumber = heatNumber;
            self.racer1Id = racer1Id;
            self.racer1Name = racer1Name;
            self.racer2Id = racer2Id;
            self.racer2Name = racer2Name;
            self.winningRacerId = winningRacerId;
            self.button1Id = 'button' + racer1Id;
            self.button2Id = 'button' + racer2Id;
        }
        
        function RoundViewModel() {

            var self = this;
            
            // data

            self.rounds = [1, 2, 3, 4, 5, 6, 7];

            self.races = ko.observableArray();
            self.roundNumber = ko.observable();

            // behaviors

            self.showRound = function (roundId) {
                location.hash = 'round/' + roundId;
            };
            
            self.showRace = function (raceItem) {
                alert('showRace:' + raceItem.raceId);
            };

            self.showRacer1Winner = function (raceItem) {

                $.ajax({
                    url: '/api/match?matchId=' + raceItem.raceId + '&winningracerid=' + raceItem.racer1Id,
                    type: 'PUT',
                    success: function() {
                        raceItem.winningRacerId = raceItem.racer1Id;
                    }
                });

            };

            self.showRacer2Winner = function (raceItem) {
                alert('showRacer2Winner:' + raceItem.racer2Name);
            };

            self.clearRaceWinner = function (raceItem) {
                alert('clearRaceWinner:' + raceItem.raceId);
            };

            self.showRoundView = function(roundId) {

                self.roundNumber(roundId);

                self.races.removeAll();

                $.get('/api/match?roundId=' + roundId, function(data) {
                    for (var x = 0; x < data.length; x++) {
                        var m = data[x];
                        self.races.push(
                            new RaceItem(
                                m.MatchId,
                                m.RaceNumber,
                                m.Racer1Id,
                                racerCache[parseInt(m.Racer1Id)].Name,
                                m.Racer2Id,
                                racerCache[parseInt(m.Racer2Id)].Name,
                                m.WinningRacerId));
                    }
                });

                //self.races.push(new RaceItem(55, '1', 60, 'Alice' + roundId, 61, 'Bob'));
                //self.races.push(new RaceItem(56, '2', 62, 'Charles' + roundId, 63, 'Dan'));
                //self.races.push(new RaceItem(57, '3', 64, 'Eddie' + roundId, 65, 'Frank'));

                showView('#roundView');
            };

            Sammy(function () {
                this.get('#:controller', function () {
                    switch (this.params.controller) {
                        case 'round':
                            showView('#bracketView');
                            break;
                        case 'admin':
                            showView('#adminView');
                            break;
                        default:
                            alert('unexpected: ' + this.params.controller);
                            break;
                    }
                });
                this.get('#:controller/:id', function () {
                    switch (this.params.controller) {
                        case 'round':
                            self.showRoundView(this.params.id);
                            break;
                        default:
                            alert('unexpected: ' + this.params.controller);
                            break;
                    }
                });
                this.get('', function () {
                    this.app.runRoute('get', '#round');
                });
            }).run();
        }

        var racerCache = null;
        
        $(function () {

            $.get('/api/racers2', function(data) {
                racerCache = data;
            });

            $('#clearWinningRacersButton').click(function () {

                if (!window.confirm('Clear Winning Racers?'))
                    return;

                $.post('/Admin/ClearWinningRacers', function (isGood) {
                    if (!isGood) {
                        alert('no good!');
                    }
                });
            });
            
            $('#assignSequentialStartSlotsButton').click(function () {

                if (!window.confirm('Assign Sequential Start Slots Button?'))
                    return;

                $.post('/Admin/AssignSequentialStartSlots', function (isGood) {
                    if (!isGood) {
                        alert('no good!');
                    }
                });
            });
            
            $('#assignRandomStartSlotsButton').click(function () {

                if (!window.confirm('Assign Random Start Slots?'))
                    return;

                $.post('/Admin/AssignRandomStartSlots', function (isGood) {
                    if (!isGood) {
                        alert('no good!');
                    }
                });
            });
            
            $('#assignBracketsByStartSlotButton').click(function () {

                if (!window.confirm('Assign Brackets By Start Slot ?'))
                    return;

                $.post('/Admin/assignBracketsByStartSlot', function (isGood) {
                    if (!isGood) {
                        alert('no good!');
                    }
                });
            });

            ko.applyBindings(new RoundViewModel());
        });
        
    </script>
</head>
<body>
    <div>
        
        <ul>
            <li><a href="#carGallery">Car Gallery</a></li>
            <li><a href="#sponsors">Sponsors</a></li>
            <li>|</li>
            <li><a href="#round">Bracket</a></li>
            <li><a href="#stats">Stats</a></li>
            <li><a href="#admin">Admin</a></li>
        </ul>

        <div id="bracketView" class="view">
            <h1>Brackets</h1>
            <ul data-bind="foreach: rounds">
                <li><input type="button" data-bind="value: $data, click: $root.showRound"/></li>
            </ul>
        </div>
        
        <div id="roundView" class="view hidden">
            <div>
                <a href="#round">Back</a>
                <input type="button" data-bind="value: roundNumber"/>
            </div>
            <table>
                <tbody data-bind="foreach: races">
                <tr>
                    <td><input type="button" data-bind="value: heatNumber, click: $root.showRace" style="width:50px;" /></td>
                    <td><input type="button" data-bind="title: racer1Id, value: racer1Name, click: $root.showRacer1Winner, css: { selected: winningRacerId == racer1Id }" style="width:300px;"/></td>
                    <td><input type="button" data-bind="value: racer2Name, click: $root.showRacer2Winner" style="width:300px;"/></td>
                    <td><input type="button" value="Clear" data-bind="click: $root.clearRaceWinner" /></td>
                </tr>
                </tbody>
            </table>
        </div>
        
        <div id="adminView" class="view hidden">
            <h1>Admin</h1>
            <div><input id="clearWinningRacersButton" type="button" value="Clear Winning Racers" /></div>
            <div><input id="assignSequentialStartSlotsButton" type="button" value="Assign Sequential Start Slots" /></div>
            <div><input id="assignRandomStartSlotsButton" type="button" value="Assign Random Start Slots" /></div>
            <div><input id="assignBracketsByStartSlotButton" type="button" value="Assign Brackets By Start Slot" /></div>
        </div>
    </div>
</body>
</html>
