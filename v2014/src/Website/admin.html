<!DOCTYPE html>
<html>
<head>
    <title>Sample Private Page</title>
    <style type="text/css">
        body { font-family: Courier; background: #000; color: #008800; }
        #col1 li { margin: 0 0 20px 0; list-style: none; }
        input[type=button] { width: 300px; height: 40px; font: normal normal bold 16pt Courier; }

        #myTable td { vertical-align: top; }

        #myTable #col2 { padding-left: 20px; }

        .mainView { display: block; }

        .hidden { display: none; }

        #nextRaceStandardView input,
        #nextRaceUnlimitedView input { width: 200px; }

        .on { background: #ff0000;}
    </style>
</head>
<body>

    <table id="myTable">
        <tr>
            <td id="col1">
                <ul>
                    <li>
                        <input type="button"
                            value="Home"
                            data-view="home"
                            data-message='{"home":"home"}' />
                    </li>
                    <li>
                        <input type="button"
                            value="Sponsors"
                            data-view="sponsors"
                            data-message='{"sponsors":"sponsors"}' />
                    </li>
                    <li>
                        <input type="button"
                            value="Gallery"
                            data-view="gallery"
                            data-message='{"gallery":"gallery"}' />
                    </li>
                    <li>
                        <input type="button"
                            value="Standard Division"
                            data-view="standardDivision"
                            data-message='{"standardDivision":"standardDivision"}' />
                    </li>
                    <li>
                        <input type="button"
                            value="Unlimited Division"
                            data-view="unlimitedDivision"
                            data-message='{"unlimitedDivision":"unlimitedDivision"}' />
                    </li>
                    <li>
                        <input id="btnCars"
                            type="button"
                            value="Cars" />
                    </li>
                    <li>
                        <input id="btnNextRaceStandard"
                            type="button"
                            value="Next Race - Standard" />
                    </li>
                    <li>
                        <input id="btnNextRaceUnlimited"
                            type="button"
                            value="Next Race - Unlimited" />
                    </li>
                </ul>
            </td>
            <td id="col2">

                <div id="homeView" class="mainView hidden">
                    <h1>Home View</h1>
                </div>

                <div id="sponsorsView" class="mainView hidden">
                    <h1>Sponsors View</h1>
                </div>

                <div id="galleryView" class="mainView hidden">
                    <h1>Gallery View</h1>
                </div>

                <div id="standardDivisionView" class="mainView hidden">
                    <h1>Standard Division View</h1>
                </div>

                <div id="unlimitedDivisionView" class="mainView hidden">
                    <h1>Unlimited Division View</h1>
                </div>

                <div id="carsView" class="mainView hidden">
                    <table>
                        <thead>
                            <tr>
                                <th>CarId</th>
                                <th>CarNumber</th>
                                <th>DivisionId</th>
                                <th>Name</th>
                                <th>Organization</th>
                                <th>PositionId</th>
                                <th>Wins</th>
                            </tr>
                        </thead>
                        <tbody data-bind="foreach: cars">
                            <tr>
                                <td data-bind="text: CarId"></td>
                                <td data-bind="text: CarNumber"></td>
                                <td data-bind="text: DivisionId"></td>
                                <td data-bind="text: Name"></td>
                                <td data-bind="text: Organization"></td>
                                <td data-bind="text: PositionId"></td>
                                <td data-bind="text: Wins"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="nextRaceStandardView" class="mainView hidden">
                    <h1>Next Race &mdash; Standard View</h1>
                    <table width="100%">
                        <tr style="opacity: .7">
                            <td width="50%">
                                <span>CarId:</span>
                                <span data-bind="text: nextRaceStandardRacer1CarId"></span>
                            </td>
                            <td width="50%">
                                <span>CarId:</span>
                                <span data-bind="text: nextRaceStandardRacer2CarId"></span>
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <span>Car Number:</span>
                                <span data-bind="text: nextRaceStandardRacer1CarNumber"></span>
                            </td>
                            <td width="50%">
                                <span>Car Number:</span>
                                <span data-bind="text: nextRaceStandardRacer2CarNumber"></span>
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <span>Name:</span>
                                <span data-bind="text: nextRaceStandardRacer1Name"></span>
                            </td>
                            <td width="50%">
                                <span>Name:</span>
                                <span data-bind="text: nextRaceStandardRacer2Name"></span>
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <input id="nextRaceStandardRacer1WonButton"
                                       type="button"
                                       value="&#x2714;"
                                       data-bind="click: nextRaceStandardRacer1Won" />
                            </td>
                            <td width="50%">
                                <input id="nextRaceStandardRacer2WonButton" 
                                       type="button"
                                       value="&#x2714;"
                                       data-bind="click: nextRaceStandardRacer2Won" />
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" align="center">
                                <input type="button"
                                       value="&#x2716;"
                                       data-bind="click: nextRaceStandardClear" />

                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <span>Next:</span>
                                <span data-bind="text: nextNextRaceStandardRacer1"></span>
                            </td>
                            <td width="50%">
                                <span>Next:</span>
                                <span data-bind="text: nextNextRaceStandardRacer2"></span>
                            </td>
                        </tr>
                    </table>

                </div>
                
                <div id="nextRaceUnlimitedView" class="mainView hidden">
                    <h1>Next Race &mdash; Unlimited View</h1>
                    <table width="100%">
                        <tr style="opacity: .7">
                            <td width="50%">
                                <span>CarId:</span>
                                <span data-bind="text: nextRaceUnlimitedRacer1CarId"></span>
                            </td>
                            <td width="50%">
                                <span>CarId:</span>
                                <span data-bind="text: nextRaceUnlimitedRacer2CarId"></span>
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <span>Car Number:</span>
                                <span data-bind="text: nextRaceUnlimitedRacer1CarNumber"></span>
                            </td>
                            <td width="50%">
                                <span>Car Number:</span>
                                <span data-bind="text: nextRaceUnlimitedRacer2CarNumber"></span>
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <span>Name:</span>
                                <span data-bind="text: nextRaceUnlimitedRacer1Name"></span>
                            </td>
                            <td width="50%">
                                <span>Name:</span>
                                <span data-bind="text: nextRaceUnlimitedRacer2Name"></span>
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <input id="nextRaceUnlimitedRacer1WonButton" 
                                       type="button"
                                       value="&#x2714;"
                                       data-bind="click: nextRaceUnlimitedRacer1Won" />
                            </td>
                            <td width="50%">
                                <input id="nextRaceUnlimitedRacer2WonButton" 
                                       type="button"
                                       value="&#x2714;"
                                       data-bind="click: nextRaceUnlimitedRacer2Won" />
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" align="center">
                                <input type="button"
                                       value="&#x2716;"
                                       data-bind="click: nextRaceUnlimitedClear" />

                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <span>Next:</span>
                                <span data-bind="text: nextNextRaceUnlimitedRacer1"></span>
                            </td>
                            <td width="50%">
                                <span>Next:</span>
                                <span data-bind="text: nextNextRaceUnlimitedRacer2"></span>
                            </td>
                        </tr>
                    </table>

                </div>

            </td>
        </tr>
    </table>

    <script src="http://stumptown40.azurewebsites.net/Scripts/jquery-1.8.3.min.js"></script>
    <script src="http://stumptown40.azurewebsites.net/Scripts/jquery.signalR-1.0.0.js"></script>
    <script src="http://stumptown40.azurewebsites.net/signalr/hubs"></script>
    <script src="http://stumptown40.azurewebsites.net/Scripts/knockout-2.2.1.js"></script>
    <script src="http://stumptown40.azurewebsites.net/Scripts/sammy-0.7.4.min.js"></script>
    <script type="text/javascript">

        //var _baseUrl = '/';
        var _baseUrl = 'http://stumptown40.azurewebsites.net/';

        function hideMainViews() {
            $('.mainView').addClass('hidden');
        }

        function showview(viewBaseName) {
            var viewName = '#' + viewBaseName + 'View';
            $(viewName).removeClass('hidden');
        }

        function configureSammy() {

            Sammy(function () {

                this.get('#:folder', function () {
                    hideMainViews();
                    showview(this.params.folder);
                });

                //this.get('#:folder/:mailId', function () {
                //    console.log(this.params.folder + "/" + this.params.mailId);
                //});

                this.get('', function () { this.app.runRoute('get', '#home'); });

            }).run();
        }

        $(function () {
            configureSammy();
        });

        (function () {

            function carViewModel() {

                var self = this;

                self.cars = ko.observableArray();
                self.races = ko.observableArray();

                self.nextRaceStandardRacer1CarId = ko.observable(0);
                self.nextRaceStandardRacer2CarId = ko.observable(0);
                self.nextRaceStandardRaceId = ko.observable(0);

                self.nextRaceUnlimitedRacer1CarId = ko.observable(0);
                self.nextRaceUnlimitedRacer2CarId = ko.observable(0);
                self.nextRaceUnlimitedRaceId = ko.observable(0);

                self.nextNextRaceStandardRacer1CarId = ko.observable(0);
                self.nextNextRaceStandardRacer2CarId = ko.observable(0);

                self.nextNextRaceUnlimitedRacer1CarId = ko.observable(0);
                self.nextNextRaceUnlimitedRacer2CarId = ko.observable(0);

                self.nextRaceStandardRacer1Name = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceStandardRacer1CarId());
                    if (racer != null)
                        return racer.Name;
                    else
                        return '';
                });

                self.nextRaceStandardRacer2Name = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceStandardRacer2CarId());
                    if (racer != null)
                        return racer.Name;
                    else
                        return '';
                });

                self.nextRaceStandardRacer1CarNumber = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceStandardRacer1CarId());
                    if (racer != null)
                        return racer.CarNumber;
                    else
                        return '';
                });

                self.nextRaceStandardRacer2CarNumber = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceStandardRacer2CarId());
                    if (racer != null)
                        return racer.CarNumber;
                    else
                        return '';
                });

                self.nextRaceUnlimitedRacer1Name = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceUnlimitedRacer1CarId());
                    if (racer != null)
                        return racer.Name;
                    else
                        return '';
                });

                self.nextRaceUnlimitedRacer2Name = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceUnlimitedRacer2CarId());
                    if (racer != null)
                        return racer.Name;
                    else
                        return '';
                });

                self.nextRaceUnlimitedRacer1CarNumber = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceUnlimitedRacer1CarId());
                    if (racer != null)
                        return racer.CarNumber;
                    else
                        return '';
                });

                self.nextRaceUnlimitedRacer2CarNumber = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceUnlimitedRacer2CarId());
                    if (racer != null)
                        return racer.CarNumber;
                    else
                        return '';
                });

                self.nextNextRaceStandardRacer1 = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextNextRaceStandardRacer1CarId());
                    if (racer != null)
                        return racer.CarNumber + ' - ' + racer.Name;
                    else
                        return '';
                });

                self.nextNextRaceStandardRacer2 = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextNextRaceStandardRacer2CarId());
                    if (racer != null)
                        return racer.CarNumber + ' - ' + racer.Name;
                    else
                        return '';
                });

                self.nextNextRaceUnlimitedRacer1 = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextNextRaceUnlimitedRacer1CarId());
                    if (racer != null)
                        return racer.CarNumber + ' - ' + racer.Name;
                    else
                        return '';
                });

                self.nextNextRaceUnlimitedRacer2 = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextNextRaceUnlimitedRacer2CarId());
                    if (racer != null)
                        return racer.CarNumber + ' - ' + racer.Name;
                    else
                        return '';
                });

                var isChrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1;
                $.support.cors = true;
                $.connection.hub.url = _baseUrl + 'signalr';

                var chat = $.connection.navigationHub;

                $.connection.hub.start({
                    jsonp: isChrome
                }).done(function () {
                    console.log('SignalR is ready');
                });

                $('input[data-view]').on('click', function () {

                    var view = $(this).attr("data-view");
                    var data = $(this).attr("data-message");

                    chat.server.navigate(view, data);

                    location.hash = view;
                });

                $('#btnCars').on('click', function () {
                    location.hash = 'cars';
                });

                $('#btnNextRaceStandard').on('click', function () {
                    location.hash = 'nextRaceStandard';

                    $('#nextRaceStandardRacer1WonButton').removeClass('on');
                    $('#nextRaceStandardRacer2WonButton').removeClass('on');

                    $.getJSON(_baseUrl + 'api/races/GetNextRaceByDivisionId/1?callback=?', function (e) {
                        self.nextRaceStandardRacer1CarId(e.Racer1CarId);
                        self.nextRaceStandardRacer2CarId(e.Racer2CarId);

                        self.nextNextRaceStandardRacer1CarId(e.NextRacer1CarId);
                        self.nextNextRaceStandardRacer2CarId(e.NextRacer2CarId);
                        
                        self.nextRace = e;
                        self.nextRace.winnerId = 0;
                        self.nextRace.currentRound = 'Speed';
                        sendRaceViewCommand();
                    });
                });

                $('#btnNextRaceUnlimited').on('click', function () {
                    location.hash = 'nextRaceUnlimited';

                    $.getJSON(_baseUrl + 'api/races/GetNextRaceByDivisionId/2?callback=?', function (e) {
                        self.nextRaceUnlimitedRacer1CarId(e.Racer1CarId);
                        self.nextRaceUnlimitedRacer2CarId(e.Racer2CarId);

                        self.nextNextRaceUnlimitedRacer1CarId(e.NextRacer1CarId);
                        self.nextNextRaceUnlimitedRacer2CarId(e.NextRacer2CarId);

                        self.nextRace = e;
                        self.nextRace.winnerId = 0;
                        self.nextRace.currentRound = 'Unlimited';
                        sendRaceViewCommand();
                    });
                });

                getCarsData();
                getRaceData();

                self.nextRaceStandardRacer1Won = function () {
                    console.log('nextRaceStandardRacer1Won');
                    postRaceWinner(1, self.nextRaceStandardRacer1CarId(), self.nextRaceStandardRacer2CarId());
                    $('#nextRaceStandardRacer1WonButton').addClass('on');
                    $('#nextRaceStandardRacer2WonButton').removeClass('on');

                    self.nextRace.winnerId = self.nextRace.Racer1CarId;
                    sendRaceViewCommand();
                };

                self.nextRaceStandardRacer2Won = function () {
                    console.log('nextRaceStandardRacer2Won');
                    postRaceWinner(1, self.nextRaceStandardRacer2CarId(), self.nextRaceStandardRacer1CarId());
                    $('#nextRaceStandardRacer2WonButton').addClass('on');
                    $('#nextRaceStandardRacer1WonButton').removeClass('on');
                    
                    self.nextRace.winnerId = self.nextRace.Racer2CarId;
                    sendRaceViewCommand();
                };

                self.nextRaceStandardClear = function () {
                    console.log('nextRaceStandardClear');
                    console.log('self.nextRaceStandardRaceId()=' + self.nextRaceStandardRaceId());
                    $('#nextRaceStandardRacer1WonButton').removeClass('on');
                    $('#nextRaceStandardRacer2WonButton').removeClass('on');
                    clearRaceWinner(self.nextRaceStandardRaceId());

                    self.nextRace.winnerId = 0;
                    sendRaceViewCommand();
                };

                self.nextRaceUnlimitedRacer1Won = function () {
                    console.log('nextRaceUnlimitedRacer1Won');
                    postRaceWinner(2, self.nextRaceUnlimitedRacer1CarId(), self.nextRaceUnlimitedRacer2CarId());
                    $('#nextRaceUnlimitedRacer1WonButton').addClass('on');
                    $('#nextRaceUnlimitedRacer2WonButton').removeClass('on');
                    
                    self.nextRace.winnerId = self.nextRace.Racer1CarId;
                    sendRaceViewCommand();
                };

                self.nextRaceUnlimitedRacer2Won = function () {
                    console.log('nextRaceUnlimitedRacer2Won');
                    postRaceWinner(2, self.nextRaceUnlimitedRacer2CarId(), self.nextRaceUnlimitedRacer1CarId());
                    $('#nextRaceUnlimitedRacer2WonButton').addClass('on');
                    $('#nextRaceUnlimitedRacer1WonButton').removeClass('on');
                    
                    self.nextRace.winnerId = self.nextRace.Racer2CarId;
                    sendRaceViewCommand();
                };

                self.nextRaceUnlimitedClear = function () {
                    console.log('nextRaceUnlimitedClear');
                    console.log('self.nextRaceUnlimitedRaceId()=' + self.nextRaceUnlimitedRaceId());
                    clearRaceWinner(self.nextRaceUnlimitedRaceId());
                    $('#nextRaceUnlimitedRacer1WonButton').removeClass('on');
                    $('#nextRaceUnlimitedRacer2WonButton').removeClass('on');
                    
                    self.nextRace.winnerId = 0;
                    sendRaceViewCommand();
                };
                
                function sendRaceViewCommand() {

                    var e = self.nextRace;
                    
                    var json = '{'
                            + '"currentRound":"' + e.currentRound + '",'
                            + '"currentRace": [{'
                            + '"racer1":"' + e.Racer1CarId + '",'
                            + '"racer2":"' + e.Racer2CarId + ''
                            + '"}],'
                            + '"upcomingRace": [{'
                            + '"nextRacer1":"' + e.NextRacer1CarId + '",'
                            + '"nextRacer2":"' + e.NextRacer2CarId + ''
                            + '"}],'
                            + '"winnerId":"' + e.winnerId + ''
                            + '"}';

                    chat.server.navigate('raceView', json);
                }

                function clearRaceWinner(raceId) {

                    var url = _baseUrl + 'api/races/delete/' + raceId;

                    $.ajax({
                        type: 'DELETE',
                        url: url,
                        success: function () { console.log('clearRaceWinner(' + raceId + ') completed.'); }
                    });
                }

                function postRaceWinner(divisionId, winnerCarId, loserCarId) {

                    var url = _baseUrl + 'api/races';
                    var data = 'DivisionId=' + divisionId + '&CarIdWinner=' + winnerCarId + '&CarIdLoser=' + loserCarId;

                    $.ajax({
                        type: 'POST',
                        url: url,
                        data: data,
                        success: function (e) {
                            if (divisionId === 1) {
                                self.nextRaceStandardRaceId(e.RaceId);
                            } else {
                                self.nextRaceUnlimitedRaceId(e.RaceId);
                            }

                            console.log('postRaceWinner(' + divisionId + ', ' + winnerCarId + ', ' + loserCarId + ') completed; raceId=' + e.RaceId);
                        }
                    });
                }

                function getRacerByCarId(carId) {
                    for (var i = 0; i < self.cars().length; i++) {
                        if (self.cars()[i].CarId == carId) {
                            return self.cars()[i];
                        }
                    }
                    return null;
                }

                function getCarsData() {

                    $.getJSON(_baseUrl + 'api/cars?callback=?', function (e) {

                        self.cars().length = 0;

                        for (var i = 0; i < e.length; i++) {
                            e[i].Wins = 9;
                            self.cars.push(e[i]);
                        }

                        console.log(self.cars().length + ' racers received.');
                    });
                }

                function getRaceData() {

                    $.getJSON(_baseUrl + 'api/races?callback=?', function (e) {

                        self.races().length = 0;

                        for (var i = 0; i < e.length; i++) {
                            self.races.push(e[i]);
                        }

                        console.log(self.races().length + ' races received.');
                    });
                }
            }

            ko.applyBindings(new carViewModel());

        })();

    </script>
</body>
</html>
