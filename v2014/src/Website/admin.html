<!DOCTYPE html>
<html>
<head>
    <title>Sample Private Page</title>
    <style type="text/css">
        body {
            font-family: Courier;
            background: #000;
            color: #008800;
        }
        #col1 li { 
            margin: 0 0 20px 0;
            list-style: none;
        }
        input[type=button] {
            width: 600px;
            height: 40px;
            font: normal normal bold 20pt Courier;
        }

        #myTable td {
            vertical-align: top;
        }

        #myTable #col2 {
            padding-left: 20px;
        }

        .mainView {
            display: block;    
        }

        .hidden {
            display: none;
        }

        #nextRaceStandardView input {
            width: 200px;
        }

    </style>
</head>
<body>
        
    <h1>Admin Page</h1>
    
    <table id="myTable">
        <tr>
            <td id="col1">
                <ul>
                    <li>
                        <input type="button" 
                               value="Home" 
                               data-view="home" 
                               data-message='{"home":"home"}' />
                    </li>
                    <li>
                        <input type="button" 
                               value="Sponsors" 
                               data-view="sponsors" 
                               data-message='{"sponsors":"sponsors"}' />
                    </li>
                    <li>
                        <input type="button" 
                               value="Gallery" 
                               data-view="gallery" 
                               data-message='{"gallery":"gallery"}' />
                    </li>
                    <li>
                        <input type="button" 
                               value="Standard Division" 
                               data-view="standardDivision" 
                               data-message='{"standardDivision":"standardDivision"}' />
                    </li>
                    <li>
                        <input type="button" 
                               value="Unlimited Division" 
                               data-view="unlimitedDivision" 
                               data-message='{"unlimitedDivision":"unlimitedDivision"}' />
                    </li>
                    <li>
                        <input id="btnCars" 
                               type="button" 
                               value="Cars" />
                    </li>
                    <li>
                        <input id="btnNextRaceStandard" 
                               type="button" 
                               value="Next Race - Standard" />
                    </li>
                </ul>
            </td>
            <td id="col2">
                    
                <div id="homeView" class="mainView hidden">
                    <h1>Home View</h1>
                </div>
                
                <div id="sponsorsView" class="mainView hidden">
                    <h1>Sponsors View</h1>
                </div>
                
                <div id="galleryView" class="mainView hidden">
                    <h1>Gallery View</h1>
                </div>
                
                <div id="standardDivisionView" class="mainView hidden">
                    <h1>Standard Division View</h1>
                </div>
                
                <div id="unlimitedDivisionView" class="mainView hidden">
                    <h1>Unlimited Division View</h1>
                </div>
                
                <div id="carsView" class="mainView hidden">
                    <table>
                        <thead>
                            <tr>
                                <th>CarId</th>
                                <th>CarNumber</th>
                                <th>DivisionId</th>
                                <th>Name</th>
                                <th>Organization</th>
                                <th>PositionId</th>
                            </tr>
                        </thead>
                        <tbody data-bind="foreach: cars">
                            <tr>
                                <td data-bind="text: CarId"></td>
                                <td data-bind="text: CarNumber"></td>
                                <td data-bind="text: DivisionId"></td>
                                <td data-bind="text: Name"></td>
                                <td data-bind="text: Organization"></td>
                                <td data-bind="text: PositionId"></td>
                            </tr>     
                        </tbody>
                    </table>
                </div>
                
                <div id="nextRaceStandardView" class="mainView hidden">
                    <h1>Next Race &mdash; Standard View</h1>
                    <table width="100%">
                        <tr style="opacity: .7">
                            <td width="50%">
                                <span>CarId:</span>
                                <span data-bind="text: nextRaceStandardRacer1CarId"></span>
                            </td>
                            <td width="50%">
                                <span>CarId:</span>
                                <span data-bind="text: nextRaceStandardRacer2CarId"></span>
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <span>Car Number:</span>
                                <span data-bind="text: nextRaceStandardRacer1CarNumber"></span>
                            </td>
                            <td width="50%">
                                <span>Car Number:</span>
                                <span data-bind="text: nextRaceStandardRacer2CarNumber"></span>
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <span>Name:</span>
                                <span data-bind="text: nextRaceStandardRacer1Name"></span>
                            </td>
                            <td width="50%">
                                <span>Name:</span>
                                <span data-bind="text: nextRaceStandardRacer2Name"></span>
                            </td>
                        </tr>
                        <tr>
                            <td width="50%">
                                <input type="button"
                                       value="&#x2714;"
                                       data-bind="click: nextRaceStandardRacer1Won" />
                            </td>
                            <td width="50%">
                                <input type="button"
                                       value="&#x2714;"
                                       data-bind="click: nextRaceStandardRacer2Won" />
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" align="center">
                                <input type="button"
                                       value="&#x2716;"
                                       data-bind="click: nextRaceStandardClear" />

                            </td>
                        </tr>
                    </table>

                </div>

            </td>
        </tr>
    </table>

    <script src="http://stumptown40.azurewebsites.net/Scripts/jquery-1.8.3.min.js"></script>
    <script src="http://stumptown40.azurewebsites.net/Scripts/jquery.signalR-1.0.0.js"></script>
    <script src="http://stumptown40.azurewebsites.net/signalr/hubs"></script>
    <script src="Scripts/knockout-2.2.1.js"></script>
	<script src="Scripts/sammy-0.7.4.min.js"></script>
    <script type="text/javascript">

        function hideMainViews() {
            $('.mainView').addClass('hidden');
        }

        function showview(viewBaseName) {
            var viewName = '#' + viewBaseName + 'View';
            $(viewName).removeClass('hidden');
        }
        
        function configureSammy() {

            Sammy(function () {

                this.get('#:folder', function () {
                    hideMainViews();
                    showview(this.params.folder);
                });

                //this.get('#:folder/:mailId', function () {
                //    console.log(this.params.folder + "/" + this.params.mailId);
                //});

                this.get('', function () { this.app.runRoute('get', '#home'); });

            }).run();
        }
        
        $(function () {
            configureSammy();
        });

        (function() {

            function carViewModel() {

                var self = this;
                self.cars = ko.observableArray();
                self.nextRaceStandardRacer1CarId = ko.observable(0);
                self.nextRaceStandardRacer2CarId = ko.observable(0);
                self.nextRaceStandardRaceId = ko.observable(0);

                self.nextRaceStandardRacer1Name = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceStandardRacer1CarId());
                    if (racer != null)
                        return racer.Name;
                    else
                        return '';
                });
                
                self.nextRaceStandardRacer2Name = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceStandardRacer2CarId());
                    if (racer != null)
                        return racer.Name;
                    else
                        return '';
                });
                
                self.nextRaceStandardRacer1CarNumber = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceStandardRacer1CarId());
                    if (racer != null)
                        return racer.CarNumber;
                    else
                        return '';
                });

                self.nextRaceStandardRacer2CarNumber = ko.computed(function () {
                    var racer = getRacerByCarId(self.nextRaceStandardRacer2CarId());
                    if (racer != null)
                        return racer.CarNumber;
                    else
                        return '';
                });
                
                // Declare a proxy to reference the hub. 
                var isChrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1;
                $.support.cors = true;
                $.connection.hub.url = 'http://stumptown40.azurewebsites.net/signalr';

                var chat = $.connection.navigationHub; // Start the connection.

                $.connection.hub.start({
                    jsonp: isChrome
                }).done(function() {
                    $('#col2').append('<p>Ready.</p>');
                });

                $('input[data-view]').on('click', function() {

                    var view = $(this).attr("data-view");
                    var data = $(this).attr("data-message");

                    chat.server.navigate(view, data);

                    location.hash = view;
                });

                $('#btnCars').on('click', function() {
                    location.hash = 'cars';
                });

                $('#btnNextRaceStandard').on('click', function() {
                    location.hash = 'nextRaceStandard';

                    $.getJSON('http://stumptown40.azurewebsites.net/api/races/GetNextRaceByDivisionId/1?callback=?', function(e) {
                        self.nextRaceStandardRacer1CarId(e.Racer1CarId);
                        self.nextRaceStandardRacer2CarId(e.Racer2CarId);
                    });
                });
                
                $.getJSON('http://stumptown40.azurewebsites.net/api/cars?callback=?', function(e) {

                    for (var i = 0; i < e.length; i++) {
                        self.cars.push(e[i]);
                    }

                    $('#col2').append('<p>' + self.cars().length + ' racers received.</p>');
                });

                self.nextRaceStandardRacer1Won = function() {
                    console.log('nextRaceStandardRacer1Won');
                    postRaceWinner(1, self.nextRaceStandardRacer1CarId(), self.nextRaceStandardRacer2CarId());
                };

                self.nextRaceStandardRacer2Won = function() {
                    console.log('nextRaceStandardRacer2Won');
                    postRaceWinner(1, self.nextRaceStandardRacer2CarId(), self.nextRaceStandardRacer1CarId());
                };

                self.nextRaceStandardClear = function() {
                    console.log('nextRaceStandardClear');
                    clearRaceWinner(self.nextRaceStandardRaceId());
                };
                
                function clearRaceWinner(raceId) {

                    var url = "http://stumptown40.azurewebsites.net/api/races/" + raceId;

                    $.ajax({
                        type: "DELETE",
                        url: url,
                        success: function () { console.log('yay!'); }
                    });
                }
                
                function postRaceWinner(divisionId, winnerCarId, loserCarId) {

                    var data = 'DivisionId=' + divisionId + '&CarIdWinner=' + winnerCarId + '&CarIdLoser=' + loserCarId;
                    var url = "http://stumptown40.azurewebsites.net/api/races";

                    $.ajax({
                        type: "POST",
                        url: url,
                        data: data,
                        success: function(e) {
                            console.log('yay!');
                            self.nextRaceStandardRaceId = e.RacerId;
                        }
                    });
                }

                function getRacerByCarId(carId) {
                    for (var i = 0; i < self.cars().length; i++) {
                        if (self.cars()[i].CarId == carId) {
                            return self.cars()[i];
                        }
                    }
                    return null;
                }
            }
            
            ko.applyBindings(new carViewModel());

        })();

    </script>
</body>
</html>